@model QuanLyBaiDoXe.Areas.Admin.ViewModels.CardViewModel
@{
    ViewData["Title"] = "Quản lý thẻ xe";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/css/card-management.css" asp-append-version="true" />
}

<div class="page-header">
    <div>
        <h1 class="page-title">Quản lý thẻ xe</h1>
        <div class="breadcrumb">
            <a href="@Url.Action("Index", "Dashboard", new { area = "Admin" })">Trang chủ</a>
            <span>/</span>
            <span>Quản lý thẻ xe</span>
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-secondary-admin" onclick="CardManager.openModal('importModal')">
            <i class="fas fa-file-import"></i> Nhập nhiều thẻ
        </button>
        <button class="btn-primary-admin" onclick="CardManager.openModal('addModal')">
            <i class="fas fa-plus"></i> Thêm thẻ mới
        </button>
    </div>
</div>

<!-- Thống kê -->
<div class="stat-cards">
    <div class="stat-card">
        <div class="stat-card-icon teal">
            <i class="fas fa-id-card"></i>
        </div>
        <div class="stat-card-info">
            <h3 id="statTotal">@Model.Statistics.TotalCards</h3>
            <p>Tổng số thẻ</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon green">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-card-info">
            <h3 id="statActive">@Model.Statistics.ActiveCards</h3>
            <p>Đang hoạt động</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon orange">
            <i class="fas fa-car"></i>
        </div>
        <div class="stat-card-info">
            <h3 id="statInUse">@Model.Statistics.CardsInUse</h3>
            <p>Đang sử dụng</p>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-card-icon red">
            <i class="fas fa-lock"></i>
        </div>
        <div class="stat-card-info">
            <h3 id="statLocked">@Model.Statistics.LockedCards</h3>
            <p>Đã khóa</p>
        </div>
    </div>
</div>

<!-- Bộ lọc -->
<div class="filter-section">
    <form id="filterForm" class="filter-row">
        @* <div class="filter-group">
            <label>Tìm kiếm</label>
            <input type="text" id="searchKeyword" name="keyword" placeholder="Nhập mã thẻ..." />
        </div> *@
        <div class="filter-group">
            <label>Loại thẻ</label>
            <select id="filterLoaiThe" name="loaiThe">
                <option value="">Tất cả</option>
                <option value="0">Vé lượt</option>
                <option value="1">Vé tháng</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Loại xe</label>
            <select id="filterLoaiXe" name="loaiXe">
                <option value="">Tất cả</option>
                @foreach (var loaiXe in Model.VehicleTypes)
                {
                    <option value="@loaiXe.MaLoaiXe">@loaiXe.TenLoaiXe</option>
                }
            </select>
        </div>
        <div class="filter-group">
            <label>Trạng thái</label>
            <select id="filterTrangThai" name="trangThai">
                <option value="">Tất cả</option>
                <option value="1">Hoạt động</option>
                <option value="0">Đã khóa</option>
            </select>
        </div>
        <div class="filter-buttons">
            <button type="submit" class="btn-primary-admin">
                <i class="fas fa-search"></i> Lọc
            </button>
            <button type="button" class="btn-secondary-admin" id="btnResetFilter">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </form>
</div>

<!-- Danh sách thẻ -->
<div class="admin-card">
    <div class="admin-card-header">
        <h3 class="admin-card-title">
            <i class="fas fa-list"></i> Danh sách thẻ
        </h3>
    </div>

    <div class="admin-card-body">
        <table id="cardsTable" class="table table-hover" style="width:100%">
            <thead>
                <tr>
                    <th style="width: 50px;">STT</th>
                    <th>Mã thẻ</th>
                    <th>Loại xe</th>
                    <th style="width: 100px;">Loại thẻ</th>
                    <th style="width: 130px;">Trạng thái</th>
                    <th style="width: 150px;">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                <!-- DataTables will populate this -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Thêm thẻ -->
<div class="modal-overlay" id="addModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Thêm thẻ mới</h3>
            <button class="modal-close" onclick="CardManager.closeModal('addModal')">&times;</button>
        </div>
        <form id="addCardForm">
            <div class="form-group">
                <label>Mã thẻ <span style="color: red">*</span></label>
                <input type="text" id="addMaThe" name="maThe" required placeholder="VD: THE001" style="text-transform: uppercase" />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Loại xe <span style="color: red">*</span></label>
                    <select id="addMaLoaiXe" name="maLoaiXe" required>
                        <option value="">-- Chọn loại xe --</option>
                        @foreach (var loaiXe in Model.VehicleTypes)
                        {
                            <option value="@loaiXe.MaLoaiXe">@loaiXe.TenLoaiXe</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Loại thẻ</label>
                    <select id="addLoaiThe" name="loaiThe">
                        <option value="0">Vé lượt</option>
                        <option value="1">Vé tháng</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="CardManager.closeModal('addModal')">Hủy</button>
                <button type="submit" class="btn-submit">Thêm thẻ</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Nhập nhiều thẻ -->
<div class="modal-overlay" id="importModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Nhập nhiều thẻ</h3>
            <button class="modal-close" onclick="CardManager.closeModal('importModal')">&times;</button>
        </div>
        <form id="importCardForm">
            <div class="form-group">
                <label>Tiền tố mã thẻ <span style="color: red">*</span></label>
                <input type="text" id="importPrefix" name="prefix" required placeholder="VD: THE, CARD" style="text-transform: uppercase" />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Số bắt đầu <span style="color: red">*</span></label>
                    <input type="number" id="importStartNumber" name="startNumber" required min="1" value="1" />
                </div>
                <div class="form-group">
                    <label>Số lượng <span style="color: red">*</span></label>
                    <input type="number" id="importQuantity" name="quantity" required min="1" max="1000" value="10" />
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Loại xe <span style="color: red">*</span></label>
                    <select id="importMaLoaiXe" name="maLoaiXe" required>
                        <option value="">-- Chọn loại xe --</option>
                        @foreach (var loaiXe in Model.VehicleTypes)
                        {
                            <option value="@loaiXe.MaLoaiXe">@loaiXe.TenLoaiXe</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Loại thẻ</label>
                    <select id="importLoaiThe" name="loaiThe">
                        <option value="0">Vé lượt</option>
                        <option value="1">Vé tháng</option>
                    </select>
                </div>
            </div>
            <div style="background: #f5f7fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <p style="margin: 0; font-size: 13px; color: var(--dark-teal);">
                    <i class="fas fa-info-circle"></i> Xem trước: <strong id="previewCards">THE0001 → THE0010</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="CardManager.closeModal('importModal')">Hủy</button>
                <button type="submit" class="btn-submit">Nhập thẻ</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Sửa thẻ -->
<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Chỉnh sửa thẻ</h3>
            <button class="modal-close" onclick="CardManager.closeModal('editModal')">&times;</button>
        </div>
        <form id="editCardForm">
            <input type="hidden" id="editMaThe" name="maThe" />
            <div class="form-group">
                <label>Mã thẻ</label>
                <input type="text" id="editMaTheDisplay" disabled style="background: #f5f7fa" />
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Loại xe <span style="color: red">*</span></label>
                    <select id="editMaLoaiXe" name="maLoaiXe" required>
                        @foreach (var loaiXe in Model.VehicleTypes)
                        {
                            <option value="@loaiXe.MaLoaiXe">@loaiXe.TenLoaiXe</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Loại thẻ</label>
                    <select id="editLoaiThe" name="loaiThe">
                        <option value="0">Vé lượt</option>
                        <option value="1">Vé tháng</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Trạng thái</label>
                <select id="editTrangThai" name="trangThai">
                    <option value="1">Hoạt động</option>
                    <option value="0">Đã khóa</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="CardManager.closeModal('editModal')">Hủy</button>
                <button type="submit" class="btn-submit">Cập nhật</button>
            </div>
        </form>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<!-- Notification -->
<div class="notification" id="notification"></div>

@section Scripts {
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Custom JS -->
    <script src="~/js/card-management.js" asp-append-version="true"></script>
}
